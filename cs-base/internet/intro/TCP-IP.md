## TCP/IP网络模型

同一设备上的进程间通信可以通过**管道、消息队列、共享内存、信号**等，而不同设备上的进程通信就需要通过网络通信，为了兼容不同设备的多样性，需要一套通用的网络协议。

**OSI七层模型**

请不要把暗号告诉任何人（Please Do Not Tell the Secret Password to Anyone）。

- Please | 物理层（Physical Layer）
- Do | 数据链路层（Data Link Layer）
- Not | 网络层（Network Layer）
- Tell | 传输层（Transport Layer）
- Secret | 会话层（Session Layer）
- Password | 表示层（Presentation Layer）
- Anyone | 应用层（Application Layer）

**TCP/IP模型**

相较于OSI模型，TCP/IP模型只有5层，更简洁，在实际应用中更为广泛，更符合实际网络通信的需求，是互联网的基础协议。

- 物理层（Physical Layer）
- 数据链路层（Data Link Layer）
- 网络层（Network Layer）
- 传输层（Transport Layer）
- 应用层（Application Layer）

也可以把物理层和数据链路层并在一起称为网络接口层，一共4层。

### 应用层

常见的应用层协议和对应的传输层协议以及端口号。

<img src="https://cdn.jsdelivr.net/gh/peng-yq/Gallery/202406111027750.png">

大部分应用层协议都是基于TCP的，DNS既有TCP，又有UDP，而DHCP是基于UDP的。

应用层无需关注数据如何传输，只需关注为用户提供具体应用功能。应用层工作在操作系统中的用户态，传输层及以下则工作在内核态。

### 传输层

传输层为应用层提供网络支持，主要包括2个传输协议**TCP/UDP**。

TCP（传输控制协议）是**面向连接的、可靠的字节流服务，支持流量控制、超时重传、拥塞控制等功能**。能保证连接传送的数据，无差错，不丢失，不重复，且按序到达。

UDP协议相对简单，**只负责发送数据包，不保证数据包是否抵达，实时性更好，传输效率也更高**。当然UDP协议也可以实现可靠传输，只需把TCP的特性在应用层上实现。

对于视频流服务，为了保证视频的完整性和可靠性，视频播放更多的使用TCP（我们可以接受缓存再播放，但画面有马赛克等是不接受的）；而语音视频聊天强调实时性，使用UDP。

此外，对于实时多媒体数据流，还有**RTP/RTCP**两种传输层协议，前者用于传输流媒体数据 、RTCP对RTP进行控制、同步。

如果传输的数据包大小超过了**MSS（TCP最大报文段长度）**，就需要将数据包进行分块，这样即使途中有一个数据块丢失了，只需发送这一个数据块而不是整个数据包。对于TCP协议，每个分块称为**TCP段**。

**传输层的报文中会携带端口号，接收方可以识别出报文是发送给哪个进程的。浏览器客户端中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号**。

### 网络层

传输层作为应用间数据传输的媒介，服务好应用到应用间的通信即可，而实际的传输功能交给网络层。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg">

当IP报文超过了**MTU（最大传输单元，1500字节）**，会进行分片。注意TCP分块时是对应用层数据进行划分，不包括TCP头部；**而IP报文划分是对整个IP报文进行划分，包括IP头部**。

相较于传输层通过端口号去区分不同的应用，网络层则使用IP地址去区分不同的网络设备。

**IP地址分为网络号和主机号，IPV4一共4*8=32位，IPV6一共8\*16=128位。IP地址需要配合网络掩码才能算出IP地址的网络号和主机号，从而确定唯一的网络设备**。

除了寻址能力，IP协议还支持路由。当IP报文到达一个网络节点时，需要通过路由算法决定下一步走哪条路径，具体来说就是去匹配子网，并交给对应的网络，再去匹配主机。

**局域网地址**

- A类地址：10.0.0.0 - 10.255.255.255 
- B类地址：172.16.0.0 - 172.31.255.255 
- C类地址：192.168.0.0 -192.168.255.255 

### 网络接口层

网络接口层在**IP报文前面加上MAC头部，封装成数据帧**。电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。

所以说，网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

> NAT将私有IP地址转换为公有IP地址；ARP则将IP地址映射为MAC地址。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/tcpip%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.drawio.png">

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%AE%E7%82%B9/%E5%B0%81%E8%A3%85.png">

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。

### 有了IP地址，为什么还需要MAC地址

1. 先有的MAC地址，才有的IP地址
2. 集线器是物理层，交换机是数据链路层；前者无脑全部转发全部端口，非接收者需要丢弃数据包，浪费资源并且不安全；后者维护MAC地址表，直接通过特定的端口进行转发。
3. MAC地址设备唯一，最早网络规模小使用MAC地址进行通信和寻址；网络规模大了，比如需要将其他局域网的数据包通过交换机的某个端口转发到路由器，到网络层路由器则需要根据路由表将一个数据包转发到对应的子网，再转发到具体的主机。
4. 正因为交换机需要维护MAC表，端口数量也是有限的，因此对于其他局域网的数据包只需转发到特定的端口（这个端口对应的MAC地址是路由器的MAC地址），路由器再做个中转。如何确定数据包是某个局域网呢？就需要IP地址，而MAC地址的表示中前面是烧录厂商的编号，在一个局域网中使用同一种厂商的设备是不现实的。
5. 数据包传输的过程中变化的是MAC地址，源IP地址和目的IP地址是不会变化的。
6. 理论上是可以只使用IP地址。