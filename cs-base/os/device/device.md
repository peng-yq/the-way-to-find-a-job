## 设备控制器

操作系统的一个重要功能是设备管理，计算机拥有很多设备，例如键盘、鼠标、显示器等，**为了屏蔽这些设备的差异性，每个设备都有一个设备控制器，CPU通过与这些设备控制器进行交互来操控管理各种设备**。

**设备控制器通常有芯片，可以执行自己的逻辑，也有寄存器与CPU进行通信交互**：

- CPU可以写入设备控制器中的寄存器，来发送数据和命令，对设备进行操作
- CPU可以从设备控制器中的状态寄存器读取信息，来获取设备状态（比如设备是否在工作）

设备控制器中的寄存器可分为**命令寄存器，数据寄存器和状态寄存器，块设备还有缓冲区**。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%99%A8.png">

CPU对设备控制器中的寄存器进行读写比起直接读写设备会方便很多，也可以屏蔽很多差异。**输入输出设备（或者说所有设备）可分为块设备和字符设备**：

- 块设备：以块（block）为单位进行数据传输，将数据存储在块中，每个块有特定的地址，可以随机访问。硬盘和USB就是典型的块设备
- 字符设备：以字符为单位进行数据传输（通常是一个个字符流），只能按顺序读取，不能随机访问。鼠标和键盘是典型的字符设备

块设备由于以块为单位进行数据传输，数据通常较大，因此块设备控制器中通常还有缓冲区，从而避免对设备的频繁操作：

- CPU将数据写入缓冲区等到一定量时，再写入设备
- 缓冲区的数据达到一定量时，CPU才将其读入内存

CPU对设备控制器寄存器的读写可以通过2种方式：

1. 端口I/O，为设备控制器分配一个I/O端口（一种独立于内存池地址的逻辑地址，用于连接CPU和外部设备的接口，可以通过指令访问），通过特殊的汇编指令进行读写，比如in/out
2. 映射I/O，将设备控制器寄存器映射入内存中，直接进行读写

## I/O控制方式

前面提到设备控制器通常有芯片，可以执行一些逻辑。假如CPU需要读取设备中的一些数据，CPU向设备控制器中的命令寄存器发送指令，CPU发送完成后就去执行自己的任务。当设备控制器完成设备数据的读取，应该如何通知CPU呢？比较常见的有2种方式：

- 轮询等待。很蠢的一种方式，CPU会一直查询设备控制器中的状态寄存器并等待，浪费不必要的时间
- 中断。中断可分为软中断（INT指令）和硬件中断，硬件则一般通过中断控制器通知CPU任务已完成

**但中断对频繁读写数据的设备不太友好，比如磁盘，这样会经常打断CPU的工作**。对于磁盘数据读取主要通过DMA，DMA的内容之前已经讲过了，这里再从设备的角度详细介绍一下具体的流程。

DMA也是硬件设备，有设备控制器。操作系统需要读取磁盘数据时，将控制指令和需要放置的内存地址发送至DMA设备控制器。DMA控制器再将命令发送至磁盘设备控制器，磁盘设备控制器将数据读取到内存后，在总线上发送一个确认成功的信号到DMA控制器，DMA控制器收到信号后，再通过中断通知操作系统任务已经完成。整个过程操作系统/cpu只有开始和结尾阶段有参与。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/DMA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png">

## 设备驱动程序

设备控制器屏蔽了不同设备的差异，但不同设备控制器中寄存器、缓冲区的使用方式又各不相同。因此，为了**屏蔽不同设备控制器的差异，出现了设备驱动程序。设备控制器是硬件，而设备驱动程序是操作系统的一部分，是面向设备控制器设计的，通过设备驱动程序操作设备控制器**。

**设备驱动程序提供统一的接口接入操作系统**。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E6%8E%A5%E5%8F%A3%E4%B8%80%E8%87%B4%E6%80%A7.png">
 
**当设备向操作系统发送中断信号通知事件完成时，操作系统会调用对应设备驱动程序的中断处理程序来处理，通常驱动程序初始化时会注册一个中断处理程序**。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/%E4%B8%AD%E6%96%AD%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png">

## 通用块层

对于块设备，为了减少不同块设备之间的差异，Linux通过一个统一的**通用块层**来管理不同的块设备。**通用块层位于文件系统和块设备驱动程序之间，属于内核部分**，主要有2个功能：

1. 向上为文件系统和应用程序提供块设备的通用接口，向下将不同的块设备抽象为统一的块设备，并在内核层提供统一的框架来管理不同的块设备驱动程序
2. 进行I/O调度，也就是对文件系统和应用和程序的I/O请求进行排序合并，提高磁盘读写效率

Linux支持5种I/O调度算法：

1. 没有调度算法，存在于虚拟机I/O中，具体的I/O调度由物理机负责
2. FIFO
3. 完全公平调度，大部分调度器的默认算法
4. 优先级调度
5. 最终期限调度

## 存储系统I/O软件分层

Linux存储系统的I/O从上自下可以分为3个层次

- 文件系统层：包括虚拟文件系统和其他文件系统，为应用程序提供了访问文件的标准接口，向下通过通用块层访问和管理磁盘数据
- 通用块层：包括块设备的I/O队列和I/O调度器
- 设备层：包括硬件设备，设备控制器和设备驱动程序，负责最终的物理I/O操作。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/I_O%E8%BD%AF%E4%BB%B6%E5%88%86%E5%B1%82.png">

通过文件系统接口，使得Linux下万物皆文件。

由于存储系统的I/O很慢，Linux提供了很多缓存机制来提高I/O效率：

1. 通过**页缓存，索引节点缓存和目录项缓存**等多种机制，减少对块设备的直接调用
2. 通过**缓冲区**提高块设备的访问效率

## 键盘敲入字母会发生什么

通过I/O桥接器，将CPU、内存和I/O总线连接起来。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/CPU%20%E7%A1%AC%E4%BB%B6%E6%80%BB%E7%BA%BF%E5%9B%BE.png">

当使用键盘敲入字符，比如A时，键盘产生一个信号，键盘设备控制器将数据（扫描码）缓冲在寄存器中，并通过中断给CPU发送请求。CPU收到请求后，首先保存上下文，然后通过键盘的驱动程序中的中断处理程序进行处理。中断处理函数读取寄存器中的数据，如果是显示字符则会将其翻译成对应的ASCII码，并将其放置读缓冲区队列中。显示器的驱动程序会定期从读缓冲区队列中读取数据，并放置写缓冲区队列，再将写缓冲区队列中的数据写入显示设备控制器中寄存器的数据缓冲区中，最后再进行显示。一旦中断处理程序完成，CPU将恢复上下文。
