## 在4GB内存物理内存的机器上申请8GB内存

### 32位系统

申请的内存虽然是虚拟内存，为每个进程分配独立完整的地址空间。但在第一次访问这些虚拟地址时，会产生缺页中断，操作系统为其分配物理内存。32位系统的机器，最多能支持寻址到4GB，但其中1GB用于内核地址空间，3GB为用户地址空间，因此在32位机器上，申请8GB内存会出现分配失败（申请4GB内存也会出现分配失败）。

### 64位系统

64位系统所支持寻址的地址大小是远大于8GB的，在64位系统，物理内存为4GB的机器上进行8GB内存申请，操作系统会为其申请虚拟内存，只要不读写这部分内存，就不会为其申请物理内存。

但需要对overcommit_memory这个参数进行修改，避免申请失败：

- 如果值为 0（默认值），代表：Heuristic overcommit handling，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。Heuristic的意思是“试探式的”，内核利用某种算法猜测你的内存申请是否合理，大概可以理解为单次申请不能超过free memory + free swap + pagecache的大小 + SLAB中可回收的部分 ，超过了就会拒绝overcommit。
- 如果值为 1，代表：Always overcommit. 允许overcommit，对内存申请来者不拒。
- 如果值为 2，代表：Don’t overcommit. 禁止overcommit。

通过开启上述参数可以申请很大的内存，比如在64位系统中申请127t内存（不能申请128t（64位机器中内核空间和用户空间各占128t），进程的运行也需要虚拟内存）。但是如果没有开启swap的话可能会导致操作系统使用OOM杀掉这个进程，虽然没有访问申请内存中的虚拟地址，但申请的过程中也需要用到物理内存，比如保存这些虚拟内存的元数据之类的。

### swap

进行后台内存回收的守护进程kswapd。

Linux提供了两种不同的方法启用Swap，分别是Swap分区（Swap Partition）和Swap文件（Swapfile）：

- Swap分区是硬盘上的独立区域，该区域只会用于交换分区（换出的匿名内存），其他的文件不能存储在该区域上，我们可以使用swapon -s命令查看当前系统上的交换分区；
- Swap文件是文件系统中的特殊文件，它与文件系统中的其他文件也没有太多的区别；