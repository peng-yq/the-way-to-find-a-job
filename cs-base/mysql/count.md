### mysql聚合函数

**MySQL 提供了一系列强大的聚合函数，用于在查询中对数据进行汇总和统计**。聚合函数在 `GROUP BY` 子句中尤为常用，但也可以在没有 `GROUP BY` 的情况下使用，来对整个结果集进行汇总。

1. `COUNT()` 函数用于计算行数。
2. `SUM()` 函数用于计算列值的总和。
3. `AVG()` 函数用于计算列值的平均值。
4. `MAX()` 函数用于查找列中的最大值。
5. `MIN()` 函数用于查找列中的最小值。
6. `GROUP_CONCAT()` 函数用于将组中的值连接成一个字符串。

### count() 是什么？

count() 是一个聚合函数，函数的参数不仅可以是字段名，也可以是其他任意表达式，该函数作用是**统计符合查询条件的记录中，函数指定的参数不为 NULL 的记录有多少个**。假设 count() 函数的参数是字段名，如下：

```sql
select count(name) from t_order;
```

这条语句是统计「 t_order 表中，name 字段不为 NULL 的记录」有多少个。也就是说，**如果某一条记录中的 name 字段的值为 NULL，则就不会被统计进去**。

再来假设 count() 函数的参数是数字 1 这个表达式，如下：

```sql
select count(1) from t_order;
```

**这条语句是统计「 t_order 表中，1 这个表达式不为 NULL 的记录」有多少个。1 这个表达式就是单纯数字，它永远都不是 NULL，所以上面这条语句，其实是在统计 t_order 表中有多少个记录**。

在通过 count 函数统计有多少个记录时，**MySQL 的 server 层会维护一个名叫 count 的变量。server 层会循环向 InnoDB 读取一条记录，如果 count 函数指定的参数不为 NULL，那么就会将变量 count 加 1，直到符合查询的全部记录被读完，就退出循环。最后将 count 变量的值发送给客户端**。

1. 如果表里只有主键索引，没有二级索引时，那么，InnoDB 循环遍历聚簇索引，将读取到的记录返回给 server 层，然后读取记录中的 id 值，就会 id 值判断是否为 NULL，如果不为 NULL，就将 count 变量加 1。
2. 但是，如果表里有二级索引时，InnoDB 循环遍历的对象就不是聚簇索引，而是二级索引。因为二级索引会占用更少的空间

### count(1) 执行过程是怎样的？

如果表里只有主键索引，没有二级索引时。InnoDB 循环遍历聚簇索引（主键索引），将读取到的记录返回给 server 层，**但是不会读取记录中的任何字段的值**，因为 count 函数的参数是 1，不是字段，所以不需要读取记录中的字段值。

如果表里有二级索引时，InnoDB 循环遍历的对象就二级索引了。

### count(*) 执行过程是怎样的？

**count(`*`) 其实等于 count(`0`)**，也就是说，当你使用 count(`*`) 时，MySQL 会将 `*` 参数转化为参数 0 来处理。

### count(字段) 执行过程是怎样的？

count(字段) 的执行效率相比前面的 count(1)、 count(*)、 count(主键字段) 执行效率是最差的。

```sql
// name不是索引，普通字段
select count(name) from t_order;
```

对于这个查询来说，会采用全表扫描的方式来计数，所以它的执行效率是比较差的。

![图片](https://cdn.xiaolincoding.com//mysql/other/f24dfeb85e2cfce0e4dc3a17b893b3f5.png)

### InnoDB和MyISAM对于count的区别

对于InnoDB，count 函数需要通过遍历的方式来统计记录个数。但是在 MyISAM 存储引擎里，执行 count 函数的方式是不一样的，**通常在没有任何查询条件下的 count(*)，MyISAM 的查询速度要明显快于 InnoDB。使用 MyISAM 引擎时，执行 count 函数只需要 O(1 )复杂度，这是因为每张 MyISAM 的数据表都有一个 meta 信息有存储了row_count值，由表级锁保证一致性，所以直接读取 row_count 值就是 count 函数的执行结果**。而 InnoDB 存储引擎是支持事务的，同一个时刻的多个查询，由于多版本并发控制（MVCC）的原因，InnoDB 表“应该返回多少行”也是不确定的，所以无法像 MyISAM一样，只维护一个 row_count 变量。**而当带上 where 条件语句之后，MyISAM 跟 InnoDB 就没有区别了，它们都需要扫描表来进行记录个数的统计。**

### 如何优化 count(*)？

如果对一张大表经常用 count(*) 来做统计，其实是很不好的。

1. **近似值：如果你的业务对于统计个数不需要很精确，可以使用 show table status 或者 explain 命令来表进行估算。**

<img src="https://cdn.xiaolincoding.com//mysql/other/7590623443e8f225e5652109e6d9e3d2.png">

2. **额外表保存计数值:当我们在数据表插入一条记录的同时，将计数表中的计数字段 + 1。也就是说，在新增和删除操作时，我们需要额外维护这个计数表。**